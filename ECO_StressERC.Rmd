---
title: "Perceived Stress Predicts Emotion Regulation Choice: The Role of Cognitive Resources, Depressive Symptoms, and Beliefs"
author: "Mengzhe Wei, Tammy English"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    toc: yes
    toc_float:
      collapsed: true
---

# ECO Stress and ER Choice Analysis
Notes: Started 17 Sep 2024 by Mengzhe Wei to run analysis looking at ER Decisions and strategy selection based on stress. 
Within person (level 1): stress level in EMA
Between person (level 2): Perceived stress scale
Moderators: CES-D, dweck.sum (implicit beliefs about emotion), MCI groups (young, CN, MCI), cogflu.uc (cognitive fluid score uncorrected)
Outcome variables: 
1. Whether participant chose to influence their emotions; 
2. the frequency of strategy use

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
# Set up packages and upload data.
rm(list=ls());
library(boxr);   
box_auth(); 
wustl.box <- TRUE;
#Packages
library(lme4); library(knitr); library(RColorBrewer); library (kableExtra);library(correlation); library(tidyverse);library(boxr); library(psych)
#Load the dataset
data_files <- box_ls('278065273295') 
file_name <- paste0("ECO_ESM_person-level.csv")
file_id <- box_search(file_name)
ESM <- box_read(file_id) %>% as.data.frame()
file_name <- paste0("ECO_baseline.csv")
file_id <- box_search(file_name)
survey <- box_read(file_id) %>% as.data.frame()
```

## Data Quality Check & Dataset Cleaning
```{r QC, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
# Found participants with no PSS score
missing_PSS <- survey %>%
  filter(is.na(perceived_stress_sum))%>%
  select(PID)
#Frequency of influencing their emotions
emotions_influence_summary <- ESM %>%
  group_by(PID) %>%
  summarize(yes_count = sum(esm_influence_emo == 1, na.rm = TRUE),
            yes_percentage = yes_count/63)
hist(emotions_influence_summary$yes_percentage, breaks = 20, border = "black",main = "ESM ER Percentage", xlab = "Percentage of time selecting YES for influencing emotions", ylab = "# of Participants")
#Given that many participants also indicated that they did try to influence their emotions despite answering "no" to emotion regulation since the last survey, we decided to include those who indicated that the most recent time that they influence their emotions were 0-1.5 hours before the prompt, if it wasn't captured by the last survey. Since each interval is 2 hours, 0-1.5 should be able to capture the ER between two prompts.

data <- ESM %>%
  mutate (Group = factor(Group, levels = 0:2, labels = c("YA","CN","MCI"))) %>%
  group_by(PID, Group, sd.cogflu.uc, perceived_stress_sum, CES_D_sum,dweck.sum) %>%
  summarize(n_total_completed = sum(completed==1), 
            n_total_ER = sum(completed==1 & esm_time_manage %in% 1:4),
            perc_ER = n_total_ER/n_total_completed,
            n_distr = sum(esm_time_manage %in% 1:4 & (esm_howinfluence == 10 | er_othermethods_distraction == 1), na.rm = TRUE),
            n_min = sum(esm_time_manage %in% 1:4 & (esm_howinfluence == 12 | er_othermethods_minimize == 1), na.rm = TRUE), 
            n_reap = sum(esm_time_manage %in% 1:4 & (esm_howinfluence == 11 | er_othermethods_posreapp == 1), na.rm = TRUE),
            perc_distr = n_distr/n_total_ER,
            perc_min = n_min/n_total_ER,
            perc_reap = n_reap/n_total_ER,
            stress_mean = mean(esm_stressed,na.rm=TRUE))
#Check internal consistency
CESD <- select(survey,CES_D_1:CES_D_20)
omega(CESD) #alpha=0.93, omega=0.95
PSS <- select(survey,c(perceived_stress_1:perceived_stress_3,perceived_stress_4r,perceived_stress_5r,perceived_stress_6,perceived_stress_7r, perceived_stress_8r,perceived_stress_9,perceived_stress_10))
omega(PSS) #alpha=0.89, omega=0.9
belief <- select(survey,Emotion_Beliefs_1r,Emotion_Beliefs_2,Emotion_Beliefs_3, Emotion_Beliefs_4r)
omega(belief) #alpha=0.75, omega = 0.79
```

## Data distribution
```{r distribution,eval=TRUE, echo=TRUE, warning=FALSE, message=TRUE}
layout(matrix(1:12, 3,4, byrow=TRUE)); 
par(mar = c(2, 2, 2, 1), mgp = c(1.1, 0.2, 0), tcl = -0.3)
#Check distribution of all data; loop through histogram
variables <- c("perceived_stress_sum","CES_D_sum", "dweck.sum","sd.cogflu.uc","n_total_completed","n_total_ER", "perc_ER","perc_distr","perc_min","perc_reap","stress_mean")
for (vid in 1:length(variables)) { #vid<-1
  hist(data[[variables[vid]]], breaks = 20, border = "black",main = variables[vid], xlab = variables[vid], ylab = "# of Participants")
}
# boxplot to check the relationship between cognitive fluid score and cognitive impairment
boxplot(data$sd.cogflu.uc~data$Group, main="cognitive fluid score by cognitive impairment group", xlab= "Group", ylab="Score", 
        col = c("lightblue", "lightgreen", "lightcoral"),
        border = "black",
        notch = TRUE,
        varwidth = TRUE)
```

## Demographics
```{r Demo, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
#Demo table
demo.sum <- ESM %>% distinct(PID, .keep_all=TRUE) %>%
  select(PID, Group, Race2_1, Race2_2, Race2_3, Race2_4, Race2_5, Race2_6, Race2_7, 
         Gender, Age)
#Group, 0=young adult, 1=CN older adults, 2=MCI older adult
demo.sum %>%
  mutate (Group = factor(Group, levels = 0:2, labels = c("YA","CN","MCI"))) %>%
  count(Group)
#Race
demo.sum %>%
  summarise(
    African_American_Black = mean(Race2_1), 
    American_Indian_Alaskan_Native = mean(Race2_2),
    Asian_Asian_American_Pacific_Islander = mean(Race2_3),
    Middle_Eastern_Arab_American = mean(Race2_4),
    Caucasian_European_American = mean(Race2_5),
    Hispanic_Latino = mean(Race2_6),
    Other = mean(Race2_7)
  )
#Age
demo.sum %>%
  summarise(
    mean_age=mean(Age),
    sd_age=sd(Age),
    min_age=min(Age),
    max_age=max(Age)
  )
#Age group by cognitive group
demo.sum %>%
  group_by(Group) %>%
  summarise(
    mean_age=mean(Age),
    sd_age=sd(Age),
    min_age=min(Age),
    max_age=max(Age)
  )
#Gender
demo.sum %>%
  mutate (Gender = factor(Gender, levels = 0:2, labels = c("male","female","other"))) %>%
  count(Gender)
```

## Descriptive Statistics
```{r descriptivestats, echo=TRUE, eval=TRUE, warning=F, message=F}
#Summarizing means, SD, SE, and Ranges for all variables involved. Graph the distribution if needed. 
#Centering
data <- data %>% 
  mutate( 
    PSS_gmc = scale(perceived_stress_sum, center = T, scale = F),
    CESD_gmc = scale(CES_D_sum, center = T, scale = F),
    IBES_gmc = scale(dweck.sum, center = T, scale = F),
    NIHCB_gmc = scale(sd.cogflu.uc, center = T, scale = F))
#OVerall stats
describe(data[c(variables, "PSS_gmc", 
                    "CESD_gmc", "IBES_gmc", "NIHCB_gmc")])

```
##Correlation

```{r cor, echo=TRUE,eval=TRUE,warning=F, message=F}
correlation_results <- corr.test(data_all[, c("distr_reap","distr_min","min_reap","perceived_stress_sum","CES_D_sum","dweck.sum","sd.cogflu.uc")])
correlation_results
```