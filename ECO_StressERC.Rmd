---
title: "Perceived Stress Predicts Emotion Regulation Choice: The Role of Cognitive Resources, Depressive Symptoms, and Beliefs"
author: "Mengzhe Wei, Tammy English"
date: "`r Sys.Date()`"
output: pdf_document
---
# ECO Stress and ER Choice Analysis
```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
# Set up packages and upload data.
rm(list=ls());
library(boxr);   
box_auth(); 
wustl.box <- TRUE;
#Packages
library(lme4); library(knitr); library(RColorBrewer); library (kableExtra);library(correlation); library(tidyverse);library(boxr)
source("summarySEwithin2.R")
#Load the dataset
data_files <- box_ls('278065273295') 
file_name <- paste0("ECO_ESM_person-level.csv")
file_id <- box_search(file_name)
data <- box_read(file_id) %>% as.data.frame()
```
## Data Quality Check
```{r QC, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# unique(data$PID[is.na(data$perceived_stress_sum)])
data_clean<-data[!is.na(data$perceived_stress_sum),]
PSS <- data_clean %>%
  distinct(PID, .keep_all=TRUE) %>%
  select(PID,perceived_stress_sum)
# PSS$PID[PSS$perceived_stress_sum==0]
ESM_completion_rate <- data_clean %>%
  group_by(PID) %>%
  summarise(
    total_surveys = n(),
    completed_surveys = sum(completed),
    completion_rate = completed_surveys / total_surveys
  )
#Frequency of influencing their emotions
emotions_influence_summary <- data_clean %>%
  group_by(PID) %>%
  summarize(yes_count = sum(esm_influence_emo == 1, na.rm = TRUE),
            yes_percentage = yes_count/63)
strategy_use_summary <- data_clean %>%
  group_by(PID) %>%
  summarize(n_distr = sum(esm_howinfluence == 10 | er_othermethods_distraction == 1, na.rm = TRUE),
            n_min = sum(esm_howinfluence == 12 | er_othermethods_minimize == 1, na.rm = TRUE), 
            n_reap = sum(esm_howinfluence == 11 | er_othermethods_posreapp == 1, na.rm = TRUE),
            n_total_strategy_selection = sum(esm_howinfluence >= 1 & esm_howinfluence <= 15 | 
                                               er_othermethods_bxactivation == 1 | er_othermethods_reminisce == 1 |
                                               er_othermethods_change == 1 | er_othermethods_accept == 1 | 
                                               er_othermethods_savoring == 1 | er_othermethods_rumination == 1 | 
                                               er_othermethods_capitalize == 1 | er_othermethods_socsharing == 1 |
                                               er_othermethods_distraction == 1 | er_othermethods_posreapp == 1 |
                                               er_othermethods_minimize == 1 | er_othermethods_coreapp == 1 |
                                               er_othermethods_suppress == 1 | er_othermethods_masking == 1,na.rm = TRUE),
            perc_distr = n_distr/n_total_strategy_selection,
            perc_min = n_min/n_total_strategy_selection,
            perc_reap = n_reap/n_total_strategy_selection)
strategy_use_summary
#Checking which one did not use any strategy
#strategy_use_summary$PID[strategy_use_summary$n_total_strategy_selection==0]
data_clean<-data_clean[data_clean$PID !=1218, ]
```
`r unique(data$PID[is.na(data$perceived_stress_mean)])` are excluded from the analysis due to not completing Perceived Stress Scale. `r strategy_use_summary$PID[strategy_use_summary$n_total_strategy_selection==0]` is excluded from the analysis due to not selecting any strategy to change their emotion.
The range of daily survey completion rate is from `r min(ESM_completion_rate$completion_rate)` to `r max(ESM_completion_rate$completion_rate)`. 
The average completion rate is `r mean(ESM_completion_rate$completion_rate)` with a standard deviation of `r sd(ESM_completion_rate$completion_rate)`.
The range of PSS score is from `r min(PSS$perceived_stress_sum)` to `r max(PSS$perceived_stress_sum)`. 
The average completion rate is `r mean(PSS$perceived_stress_sum)` with a standard deviation of `r sd(PSS$perceived_stress_sum)`.

## Demographics
```{r Demo, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
#Demo table
demo.sum <- data_clean %>% distinct(PID, .keep_all=TRUE) %>%
  select(PID, Group, Race2_1, Race2_2, Race2_3, Race2_4, Race2_5, Race2_6, Race2_7, Gender, Age)
#Group, 0=young adult, 1=CN older adults, 2=MCI older adult
demo.sum %>%
  mutate (Group = factor(Group, levels = 0:2, labels = c("YA","CN","MCI"))) %>%
  count(Group)
#Race
demo.sum %>%
  summarise(
    African_American_Black = mean(Race2_1), 
    American_Indian_Alaskan_Native = mean(Race2_2),
    Asian_Asian_American_Pacific_Islander = mean(Race2_3),
    Middle_Eastern_Arab_American = mean(Race2_4),
    Caucasian_European_American = mean(Race2_5),
    Hispanic_Latino = mean(Race2_6),
    Other = mean(Race2_7)
  )
#Age
demo.sum %>%
  summarise(
    mean_age=mean(Age),
    sd_age=sd(Age),
    min_age=min(Age),
    max_age=max(Age)
  )
#Age group by cognitive group
demo.sum %>%
  group_by(Group) %>%
  summarise(
    mean_age=mean(Age),
    sd_age=sd(Age),
    min_age=min(Age),
    max_age=max(Age)
  )
#Gender
demo.sum %>%
  mutate (Gender = factor(Gender, levels = 0:2, labels = c("male","female","other"))) %>%
  count(Gender)
```

## Descriptive Statistics
```{r descriptivestats, echo=TRUE, eval=TRUE, warning=F, message=F}
#Summarizing means, SD, SE, and Ranges for all variables involved. Graph the distribution if needed. 
#Frequency of influencing their emotions
hist(emotions_influence_summary$yes_percentage, breaks = 20, border = "black", main = "Distribution of Yes Responses for Influencing Emotions", xlab = "Percentage of Yes Responses", ylab = "Number of Participants") #The overall indication of influencing their emotions is low. However, many participants still answered about the strategies that they use despite answering not trying to change their emotions. 

#Frequency of distr use
strategy_use_summary$PID[strategy_use_summary$n_total_strategy_selection==0]
strategy_use_summary %>%
  summarise(
    mean_distr=mean(strategy_use_summary$perc_distr),
    sd_distr=sd(strategy_use_summary$perc_distr),
    min_distr=min(strategy_use_summary$perc_distr),
    max_distr=max(strategy_use_summary$perc_distr)
  )
#Frequency of min use
#Frequency of reap use
#PSS 
#CES-D
#IBES
#NIHTB-CB
nback.clean <- left_join(nback.lab, demo.sum %>% 
                       select(Participant.ID, Group.Assignment, Age.Group), 
                       by = c("subID" = "Participant.ID")) %>% 
  select(subID, level, kind, acc, RT, Group.Assignment, Age.Group) %>% 
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
         taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)),
         ageCode = factor (Age.Group, levels = c("MA", "OA"), labels = c(0,1)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure")
nback.clean$taskCode <- as.numeric(as.character(nback.clean$taskCode))
nback.clean$ageCode <- as.numeric(as.character(nback.clean$ageCode))
nback.clean$groupCode <- as.numeric(as.character(nback.clean$groupCode))

#Accuracy - without group
m.nback.lab.acc <- glmer(data = nback.clean, acc ~ taskCode + (1 | subID), family = "binomial")
summary(m.nback.lab.acc)

nback.acc <- summarySEwithin2(nback.clean, measurevar = "acc", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci)) %>% arrange(level)
kable(nback.acc, digits = 3) %>% kable_styling()

p.nback.acc <- ggplot(nback.acc, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") 
p.nback.acc + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#Accuracy - with groups
m.nback.lab.acc2 <- glmer(data = nback.clean, acc ~ taskCode + ageCode + groupCode + (1 | subID), family = "binomial")
summary(m.nback.lab.acc2)
nback.acc2 <- summarySEwithin2(nback.clean, measurevar = "acc", withinvars = c("level","kind","Group.Assignment","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
          rename("trial_type" = kind) %>% 
          select(c(level, trial_type, acc, sd, se, ci, Group.Assignment, Age.Group)) %>%
          arrange(level)
p.nback.acc2 <- ggplot(nback.acc2, aes(x=level, y=acc, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") +
  facet_grid(Group.Assignment ~ Age.Group) + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.acc2

#RT

m.nback.lab.RT <- lmer(data = nback.clean, RT ~ taskCode + (1 | subID))
summary(m.nback.lab.RT)
nback.RT <- summarySEwithin2(nback.clean, measurevar = "RT", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci)) %>% arrange(level)
kable(nback.RT, digits = 3) %>% kable_styling()

p.nback.RT <- ggplot(nback.RT, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)")
p.nback.RT + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#RT - with group
m.nback.lab.RT2 <- lmer(data = nback.clean, RT ~ taskCode +  ageCode + groupCode + (1 | subID))
summary(m.nback.lab.RT2)
nback.RT2 <- summarySEwithin2(nback.clean, measurevar = "RT", withinvars = c("level","kind","Group.Assignment","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, Group.Assignment, Age.Group)) %>% arrange(level)
kable(nback.RT2, digits = 3) %>% kable_styling()

p.nback.RT2 <- ggplot(nback.RT2, aes(x=level, y=RT, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)") +
  facet_grid(Group.Assignment ~ Age.Group) + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.RT2
```


## Cognitive Effort Discounting
### Working Memory (Black = 1-back, Red = 2-Back, Blue = 3-back, Purple = 4-back)

```{r SV_CogED, echo=FALSE,eval=FALSE,warning=F, message=F}
#clean data frame with Cog-ED SV estimates and join data across both domains (i.e., WM, speech)
d.coged.wm <- left_join(WM.coged, demo.sum %>% 
                       select(Participant.ID, Group.Assignment, Age.Group), 
                       by = c("subID" = "Participant.ID")) %>%
  group_by(subID) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)),
         taskCode = factor(task, levels=c(1,2,3), labels=c(-1,0,1)),
         task = factor(task, levels=c(1,2,3), labels=c("Red","Blue","Purple")))

d.coged.wm$taskCode <- as.numeric(as.character(d.coged.wm$taskCode))
d.coged.wm$ageCode <- as.numeric(as.character(d.coged.wm$ageCode))
d.coged.wm$groupCode <- as.numeric(as.character(d.coged.wm$groupCode))

d.coged.wm.sub <- d.coged.wm %>% group_by(subID, task, Age.Group, Group.Assignment) %>%
summarise(meanSV = mean(SV))

#testing for differences across task & condition (red, blue, purple)
#There's no domain so here's the modified version
m.SV <- lmer(data = d.coged.wm, SV ~ taskCode + (1 | subID))
summary(m.SV)

#testing for differences across task & condition (red, blue, purple) controlling for age and group
m.SV.age.group <- lmer(data = d.coged.wm, SV ~ taskCode + ageCode + groupCode + (1 | subID))
summary(m.SV.age.group)
```

``` {r CogED_SV_Plot, echo=FALSE,eval=FALSE,warning = F, message = F}
#summary of data for plotting
CogED_sum <- summarySEwithin2(d.coged.wm, measurevar = "SV", withinvars = c("task","Group.Assignment","Age.Group"), idvar = "subID")
#Plotting
fig.SV <- ggplot(CogED_sum, aes(x=task, y=SV, fill=task, color=task)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = d.coged.wm.sub, aes(x=task, y=meanSV, color=task),
             stat="identity", alpha=0.7, position = "jitter") +
  coord_cartesian(ylim=c(0,1)) +
  scale_x_discrete(breaks=NULL) +
  xlab("") + ylab("Subjective Value") +
  facet_grid(Group.Assignment ~ Age.Group) + 
  scale_fill_brewer(palette = "Set1",  name="Task Effort Level", labels=c("Low","Medium","High")) + scale_color_brewer(palette = "Set1", name="Task Effort Level", labels=c("Low","Medium","High"))
fig.SV
#Plotting with participants' lines
fig.SV.lines <- ggplot(CogED_sum, aes(x=task, y=SV)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = d.coged.wm.sub, aes(x=task, y=meanSV),
             stat="identity", alpha=0.7) +
  geom_line(data = d.coged.wm.sub, aes(x=task, y=meanSV, group=subID, colour = factor(subID)), alpha = .5) +
  coord_cartesian(ylim=c(0,1)) +
  xlab("Task") + ylab("Subjective Value") +
  facet_grid(Group.Assignment ~ Age.Group)
fig.SV.discounting <- fig.SV.lines + guides(colour=FALSE)
fig.SV.discounting

#summarizing average SV
average.SV <- d.coged.wm %>% select(subID, SV, Group.Assignment, Age.Group) %>%
  group_by(Group.Assignment,Age.Group) %>%
  summarise(SV_avg = mean(SV)) 
average.SV
```
## Self-Report Questionnaires
### NASA TLX (administered after each run of the familiarization tasks)

``` {r NASA, echo=FALSE,eval=FALSE,warning = F, message = F}
#cleaning up data structures from REDCap
NASA.wm.clean <- WM.NASA[WM.NASA$participant_id %in% fCOGED.ids,] %>% 
  pivot_longer(cols = c("black_mdemand", "black_pdemand", "black_tdemand", "red_mdemand", "red_pdemand", "red_tdemand", "blue_mdemand", "blue_pdemand", "blue_tdemand","purple_mdemand", "purple_pdemand", "purple_tdemand"), names_to = "condition", values_to = "rating") %>%
  separate(col = condition, into=c("Task","Characteristic"), sep = "_") %>%
  pivot_wider(values_from = rating, names_from = Characteristic) %>%
  rename(mental_demand = mdemand, 
         phsyical_demand = pdemand, 
         temporal_demand = tdemand) %>%
  left_join(demo.sum %>% select(Participant.ID, Group.Assignment, Age.Bin, Age.Group, Age), 
            by = c("participant_id" = "Participant.ID")) 

#Mental Demand Ratings
NASA.m.demand <- NASA.wm.clean %>% select(participant_id, Task, mental_demand, Group.Assignment,Age.Group) %>%
  group_by(participant_id, Task,Group.Assignment,Age.Group) %>%
  dplyr::summarise(mean.m.demand = mean(mental_demand)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)))
NASA.m.demand$taskCode <- as.numeric(as.character(NASA.m.demand$taskCode))
NASA.m.demand$ageCode <- as.numeric(as.character(NASA.m.demand$ageCode))
NASA.m.demand$groupCode <- as.numeric(as.character(NASA.m.demand$groupCode))

#Multi-level model (implemented in lme4)
m.mentalDemand <- lmer(mean.m.demand ~ taskCode + (1 | participant_id), data = NASA.m.demand)
summary(m.mentalDemand)

m.mentalDemand2 <- lmer(mean.m.demand ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.m.demand)
summary(m.mentalDemand2)

NASA_mdemand_sum <- summarySEwithin2(NASA.m.demand, measurevar = "mean.m.demand", withinvars = c("Task", "Group.Assignment","Age.Group"), idvar = "participant_id")
NASA_mdemand_sum$Task <- factor(NASA_mdemand_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.m.demand <- ggplot(NASA_mdemand_sum, aes(x=Task, y=mean.m.demand)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.m.demand-ci, ymax=mean.m.demand+ci), width=.2) +  
  xlab("Task") + ylab("Mental Demand") + ggtitle("Self-Reported Mental Demand") +
  facet_grid(Group.Assignment ~ Age.Group)
p.m.demand

#Effort Ratings
NASA.effort <- NASA.wm.clean %>% 
  mutate(effort = case_when(
    Task == "black" ~ black_effort,
    Task == "red" ~ red_effort,
    Task == "blue" ~ blue_effort,
    Task == "purple" ~ purple_effort
  )) %>%
  select(participant_id, Task, effort,Group.Assignment,Age.Group) %>%
  group_by(participant_id, Task,Group.Assignment,Age.Group) %>%
  dplyr::summarise(mean.effort = mean(effort)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)))
NASA.effort$taskCode <- as.numeric(as.character(NASA.effort$taskCode))
NASA.effort$ageCode <- as.numeric(as.character(NASA.effort$ageCode))
NASA.effort$groupCode <- as.numeric(as.character(NASA.effort$groupCode))

#Multi-level model (implemented in lme4)
m.effort <- lmer(mean.effort ~ taskCode + (1 | participant_id), data = NASA.effort)
summary(m.effort)
m.effort2 <- lmer(mean.effort ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.effort)
summary(m.effort2)

NASA_effort_sum <- summarySEwithin2(NASA.effort, measurevar = "mean.effort", withinvars = c("Task", "Group.Assignment","Age.Group"), idvar = "participant_id")
NASA_effort_sum$Task <- factor(NASA_effort_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.effort <- ggplot(NASA_effort_sum, aes(x=Task, y=mean.effort)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.effort-ci, ymax=mean.effort+ci), width=.2) +  
  xlab("Task") + ylab("Effort") + ggtitle("Self-Reported Effort") +
  facet_grid(Group.Assignment ~ Age.Group)
p.effort

#Frustration Ratings
NASA.frust <- NASA.wm.clean %>% 
  mutate(frustration = case_when(
    Task == "black" ~ black_frustration,
    Task == "red" ~ red_frustration,
    Task == "blue" ~ blue_frustration,
    Task == "purple" ~ purple_frustration
  )) %>%
  select(participant_id, Task, frustration,Group.Assignment,Age.Group) %>%
  group_by(participant_id, Task,Group.Assignment,Age.Group) %>%
  dplyr::summarise(mean.frust = mean(frustration)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)))
NASA.frust$taskCode <- as.numeric(as.character(NASA.frust$taskCode))
NASA.frust$ageCode <- as.numeric(as.character(NASA.frust$ageCode))
NASA.frust$groupCode <- as.numeric(as.character(NASA.frust$groupCode))
  
#Multi-level model (implemented in lme4)
m.frust <- lmer(mean.frust ~ taskCode + (1 | participant_id), data = NASA.frust)
summary(m.frust)

m.frust2 <- lmer(mean.frust ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.frust)
summary(m.frust2)

NASA_frust_sum <- summarySEwithin2(NASA.frust, measurevar = "mean.frust", withinvars = c("Task", "Group.Assignment","Age.Group"), idvar = "participant_id")
NASA_frust_sum$Task <- factor(NASA_frust_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.frust <- ggplot(NASA_frust_sum, aes(x=Task, y=mean.frust)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.frust-ci, ymax=mean.frust+ci), width=.2) +  
  xlab("Task") + ylab("Frustration") + ggtitle("Self-Reported Frustration")+
  facet_grid(Group.Assignment ~ Age.Group)
p.frust
```

## fMRI Session
### N-Back Performance

```{r nback_fmri, echo=FALSE,eval=FALSE,warning=F, message=F}
#summarizing n-back task performance in the scanner
nback.fmri.clean <- nback.fmri %>% filter(resp != 9) %>%select(subID, level, kind, acc, RT) %>%
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
        taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure") %>%
  left_join(demo.sum %>% select(Participant.ID, Group.Assignment, Age.Bin, Age.Group, Age), 
            by = c("subID" = "Participant.ID")) %>%
  mutate( ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (Group.Assignment, levels = c("Healthy control", "MDD"), labels = c(0,1)))
nback.fmri.clean$taskCode <- as.numeric(as.character(nback.fmri.clean$taskCode))
nback.fmri.clean$ageCode <- as.numeric(as.character(nback.fmri.clean$ageCode))
nback.fmri.clean$groupCode <- as.numeric(as.character(nback.fmri.clean$groupCode))

m.nback.acc.fmri <- glmer(data = nback.fmri.clean, acc ~ taskCode + (1|subID), family = "binomial")
summary(m.nback.acc.fmri)
m.nback.acc.fmri2 <- glmer(data = nback.fmri.clean, acc ~ taskCode + ageCode + groupCode + (1|subID), family = "binomial")
summary(m.nback.acc.fmri2)

#Accuracy
nback.fmri.acc <- summarySEwithin2(nback.fmri.clean, measurevar = "acc", withinvars = c("level","kind","Group.Assignment","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci, Group.Assignment,Age.Group)) %>% arrange(level)
kable(nback.fmri.acc, digits = 3) %>% kable_styling()

p.nback.fmri.acc <- ggplot(nback.fmri.acc, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back fMRI Performance (Accuracy)") + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(Group.Assignment ~ Age.Group)
nback.fmri.acc

#RT
m.nback.RT.fmri <- lmer(data = nback.fmri.clean, RT ~ taskCode + (1|subID))
summary(m.nback.RT.fmri)
m.nback.RT.fmri2 <- lmer(data = nback.fmri.clean, RT ~ taskCode + ageCode + groupCode + (1|subID))
summary(m.nback.RT.fmri2)

nback.fmri.RT <- summarySEwithin2(nback.fmri.clean, measurevar = "RT", withinvars = c("level","kind","Group.Assignment","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, Group.Assignment,Age.Group)) %>% arrange(level)
kable(nback.fmri.RT, digits = 3) %>% kable_styling()

p.nback.fmri.RT <- ggplot(nback.fmri.RT, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back fMRI Performance (RT)")+ 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(Group.Assignment ~ Age.Group)
p.nback.fmri.RT

nback.fmri.performance <- nback.fmri.clean %>% group_by(subID, level) %>%
  summarise(hitRate = (sum(hit)/16), FARate = sum(FA)/48, mRT = mean(RT)) %>%
  rename(task = "level")
```

## Cog-ED Choices

```{r WM_coged_fmri, echo=FALSE,eval=FALSE,warning=FALSE, message=FALSE}
wm.coged.fmri.clean <- WM.coged.fmri %>% filter(trial > 45) %>% filter(choice != 9) %>%
  select(-c(adjAmount, adjEff, taskAmount, ISI, valDuration, choiceDuration, maxRT)) %>%
  mutate(proxType = if_else(abs(proximityValue) == 1, "catch", "biased"),
         biasType = if_else(proximityValue >0, "low", "high"),
         trialType = if_else((proxType == "catch" & biasType == "high"), "high-catch",
                             (if_else((proxType == "catch" & biasType == "low"), "low-catch",
                             if_else((proxType == "biased" & biasType == "high"), "high-biased", "low-biased")))),
         choseHard = if_else((choice == 1), 0, 1),
         bias = if_else((biasType == "high" & choseHard == 1 | biasType == "low" & choseHard == 0), "pro", "anti"))%>%
  left_join(demo.sum %>% select(Participant.ID, Group.Assignment, Age.Bin, Age.Group, Age), 
            by = c("subID" = "Participant.ID")) 

#The breakdown for those who have fmri coged data
fmri.age.sum <- wm.coged.fmri.clean %>%
  distinct(subID, .keep_all = TRUE) %>%
  group_by(Age.Group, Group.Assignment) %>%
  summarise(total_count=n()) %>%
  as.data.frame()
fmri.age.sum

 wm.coged.fmri.hardChoice <- wm.coged.fmri.clean %>% select(subID, trialType, choseHard, Group.Assignment,Age.Group) %>% group_by(subID, trialType, Group.Assignment,Age.Group) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)
 
wm.coged.fmri.hardChoice.subj <- wm.coged.fmri.clean %>% select(subID, trialType, choseHard) %>% group_by(subID) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)

wm.coged.fmri.hardChoice.subj.sum <- wm.coged.fmri.hardChoice.subj %>%
  summarise(meanPropHard = mean(propHard), sdPropHard = sd(propHard))
 
wm.coged.prophard.sum <- summarySEwithin2(data = wm.coged.fmri.hardChoice, measurevar = "propHard", withinvars = c("trialType","Group.Assignment","Age.Group"), idvar = "subID")
wm.coged.prophard.sum$trialType <- factor(wm.coged.prophard.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))

#plotting Cog-ED choices from scanner
p.wm.coged.hardChoice <- ggplot(wm.coged.prophard.sum, aes(x=trialType, y=propHard)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=propHard-ci, ymax=propHard+ci), width=.2, size=1.1) + 
    coord_cartesian(ylim=c(0,1.05)) +
  xlab("Trial Type") + ylab("Proportion Hard Choice") + ggtitle("WM Cog-ED Choice Behavior")+
  facet_grid(Group.Assignment ~ Age.Group)
p.wm.coged.hardChoice

#summarizing RT from Cog-ED choices
wm.coged.fmri.RT.sum <- summarySEwithin2(data = wm.coged.fmri.clean, measurevar = "choiceRT", withinvars = c("trialType","bias","Group.Assignment","Age.Group"), idvar = "subID")
wm.coged.fmri.RT.sum$trialType <- factor(wm.coged.fmri.RT.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))


#plotting Cog-ED choice RT from scanner
p.wm.coged.fmri.RT <- ggplot(wm.coged.fmri.RT.sum, aes(x=trialType, y=choiceRT, fill=bias)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=choiceRT-ci, ymax=choiceRT+ci), width=.2, size=1.1) +  
  xlab("Trial Type") + ylab("RT (seconds)") + ggtitle("WM Cog-ED Choice RT")+ 
  scale_fill_brewer(palette = "Paired:2",  name="Bias Type", labels=c("Anti","Pro"))+
  facet_grid(Group.Assignment ~ Age.Group)
p.wm.coged.fmri.RT
```
